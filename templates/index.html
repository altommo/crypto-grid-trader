<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Grid Trader</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
    <!-- Previous HTML remains the same until the script section -->

    <script>
        let gridChart = null;

        // Initialize grid chart
        function initGridChart() {
            const ctx = document.getElementById('gridChart').getContext('2d');
            gridChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Grid Levels',
                        data: [],
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        // Update grid status
        async function updateGridStatus(formData = null) {
            try {
                const options = {
                    method: formData ? 'POST' : 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };

                if (formData) {
                    const data = {
                        gridSize: parseInt(formData.get('gridSize')),
                        gridSpacing: parseFloat(formData.get('gridSpacing')),
                        useBnbFees: formData.get('useBnbFees') === 'on'
                    };
                    options.body = JSON.stringify(data);
                }

                const response = await fetch('/api/grid/status', options);
                const data = await response.json();
                
                if (data.error) {
                    console.error('Error getting grid status:', data.error);
                    return;
                }
                
                document.getElementById('currentPrice').textContent = `$${data.current_price.toFixed(4)}`;
                
                // Update chart
                gridChart.data.labels = data.grid_levels.map(level => `$${level.price.toFixed(4)}`);
                gridChart.data.datasets[0].data = data.grid_levels.map(level => level.position_size);
                gridChart.update();
                
            } catch (error) {
                console.error('Error updating grid status:', error);
            }
        }

        // Run backtest
        async function runBacktest(formData) {
            try {
                // Get current form settings
                const strategyForm = document.getElementById('strategyForm');
                const strategyData = new FormData(strategyForm);
                
                // Combine with backtest settings and convert types
                const data = {
                    symbol: strategyData.get('symbol'),
                    gridSize: parseInt(strategyData.get('gridSize')),
                    gridSpacing: parseFloat(strategyData.get('gridSpacing')),
                    useBnbFees: strategyData.get('useBnbFees') === 'on',
                    days: parseInt(formData.get('days'))  // Convert days to integer
                };

                console.log('Sending backtest data:', data);  // Debug log

                const response = await fetch('/api/backtest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const results = await response.json();
                
                if (results.error) {
                    console.error('Backtest error:', results.error);
                    return;
                }
                
                document.getElementById('totalReturn').textContent = `${(results.total_return * 100).toFixed(2)}%`;
                document.getElementById('winRate').textContent = `${(results.win_rate * 100).toFixed(2)}%`;
                document.getElementById('totalTrades').textContent = results.total_trades;
                
            } catch (error) {
                console.error('Error running backtest:', error);
            }
        }

        // Event Listeners
        document.getElementById('strategyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            await updateGridStatus(formData);
        });

        document.getElementById('backtestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            await runBacktest(formData);
        });

        // Initialize on load
        initGridChart();
        updateGridStatus();
    </script>
</body>
</html>